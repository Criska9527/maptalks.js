<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="../dist/fusion.gl-dev.js"></script>
    <script src="../node_modules/three/build/three.js"></script>
    <script src="../node_modules/regl/dist/regl.js"></script>
</head>

<body>
    <canvas width="800" height="600" id="mapCanvas"></canvas>
    <script type="text/javascript">

        const canvas = document.getElementById('mapCanvas');
        const realGL = canvas.getContext('webgl');

        var cubePosition = [
            [-0.5, +0.5, +0.5], [+0.5, +0.5, +0.5], [+0.5, -0.5, +0.5], [-0.5, -0.5, +0.5], // positive z face.
            [+0.5, +0.5, +0.5], [+0.5, +0.5, -0.5], [+0.5, -0.5, -0.5], [+0.5, -0.5, +0.5], // positive x face
            [+0.5, +0.5, -0.5], [-0.5, +0.5, -0.5], [-0.5, -0.5, -0.5], [+0.5, -0.5, -0.5], // negative z face
            [-0.5, +0.5, -0.5], [-0.5, +0.5, +0.5], [-0.5, -0.5, +0.5], [-0.5, -0.5, -0.5], // negative x face.
            [-0.5, +0.5, -0.5], [+0.5, +0.5, -0.5], [+0.5, +0.5, +0.5], [-0.5, +0.5, +0.5], // top face
            [-0.5, -0.5, -0.5], [+0.5, -0.5, -0.5], [+0.5, -0.5, +0.5], [-0.5, -0.5, +0.5]  // bottom face
        ];
        const cubeElements = [
            [2, 1, 0], [2, 0, 3],       // positive z face.
            [6, 5, 4], [6, 4, 7],       // positive x face.
            [10, 9, 8], [10, 8, 11],    // negative z face.
            [14, 13, 12], [14, 12, 15], // negative x face.
            [18, 17, 16], [18, 16, 19], // top face.
            [20, 21, 22], [23, 20, 22]  // bottom face
        ];
        const regl = createREGL({
            gl : new fusion.GLContext(realGL),
            attributes : {
                alpha: true,
                depth: true,
                antialias: true
            }
        });
        const command = regl({
            vert : `
                attribute vec3 aPosition;
                uniform mat4 uProjMatrix;
                uniform mat4 uViewMatrix;
                uniform mat4 uModelMatrix;
                void main() {
                    gl_Position = uProjMatrix * uViewMatrix * uModelMatrix * vec4(aPosition, 1.0);
                }
            `,
            frag : `
                void main() {
                    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
                }
            `,
            attributes : {
                aPosition : cubePosition
            },
            uniforms : {
                // uProjMatrix : camera.projectionMatrix.toArray(),
                // uViewMatrix : camera.matrixWorldInverse.toArray(),
                // uModelMatrix : new THREE.Matrix4().makeScale(0.6, 0.6, 0.6).toArray()
                uProjMatrix : [1.0711110050565862, 0, 0, 0, 0, 1.4281480067421146, 0, 0, 0, 0, -1.002002002002002, -1, 0, 0, -0.02002002002002002, 0],
                uViewMatrix : [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, -1, 1],
                uModelMatrix :  new THREE.Matrix4().makeScale(0.6, 0.6, 0.6).toArray()
            },
            elements : cubeElements
        });
        command();


        const gl = new fusion.GLContext(realGL);
        //
        const camera = new THREE.PerspectiveCamera(70, 800 / 600, 0.01, 10);
        camera.position.z = 1;
        scene = new THREE.Scene();
        geometry = new THREE.BoxGeometry(0.5, 0.3, 0.8);
        material = new THREE.MeshNormalMaterial();
        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            context: gl
        });
        renderer.autoClear = false;
        renderer.setSize(800, 600);
        // renderer.render(scene, camera);



        function animate() {
            requestAnimationFrame(animate);

            renderer.clear(true, true, true);

            mesh.rotation.x -= 0.01;
            mesh.rotation.y -= 0.02;
            renderer.render(scene, camera);

            command();

        }

        animate();

    </script>
</body>

</html>
