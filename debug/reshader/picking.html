<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Picking</title>
  <style type="text/css">
    html,body{margin:0px;height:100%;width:100%}
    .container{width:1000px;height:800px}
  </style>
  <script src="../../node_modules/maptalks/dist/maptalks.js" type="text/javascript"></script>
  <script src="../../packages/gl/dist/maptalksgl-dev.js" type="text/javascript"></script>
  <body>
    <canvas id="canvas" width=1000 height=800 class="container" style="border : 1px solid"></canvas>
    <!-- <script src="./common/regl.js" type="text/javascript"></script> -->
    <script type="module">
        import cubeData from './common/cube.js';

        const { createREGL, mat4, reshader } = maptalksgl;


        const regl = createREGL({
            canvas : canvas
        });

        const vert = `
            attribute vec3 aPosition;
            attribute float aPickingId;
            uniform mat4 projViewModelMatrix;

            void main()
            {
                gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);

            }
        `;

        const frag = `
            precision mediump float;
            uniform vec3 color;

            void main() {
                gl_FragColor = vec4(color, 1.0);
            }
        `;

        const shader = new reshader.MeshShader({
            vert,
            frag,
            uniforms : [
                'color',
                {
                    name : 'projViewModelMatrix',
                    type : 'function',
                    fn : function (context, props) {
                        //model是自动设置的值，来源于mesh的localTransform
                        return mat4.multiply([], props['projViewMatrix'], props['modelMatrix']);
                    }
                }

            ]
        });

        const renderer = new reshader.Renderer(regl);

        const pickingVert = `
            attribute vec3 aPosition;
            uniform mat4 projViewModelMatrix;

            //引入fbo picking的vert相关函数
            #include <fbo_picking_vert>

            void main()
            {
                gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);
                //传入gl_Position的depth值
                fbo_picking_setData(gl_Position.w);
            }

        `

        //创建picking对象
        const picking = new reshader.FBORayPicking(
                renderer,
                {
                    vert : pickingVert,
                    uniforms : [
                        {
                            name : 'projViewModelMatrix',
                            type : 'function',
                            fn : function (context, props) {
                                //model是自动设置的值，来源于mesh的localTransform
                                return mat4.multiply([], props['projViewMatrix'], props['modelMatrix']);
                            }
                        }
                    ]
                },
                regl.framebuffer(canvas.width, canvas.height)
            );

        render();

        //主绘制方法
        function render() {
            // camera's position
            const cameraPos = [0, 8, 8];
            const { viewProjMatrix, viewMatrix, projMatrix } = getViewProjection(cameraPos);

            const scene = getScene();

            const uniforms = {
                'projViewMatrix' : viewProjMatrix,
                'color' : [0, 1, 0]
            };

            renderer.render(
                shader,
                uniforms,
                scene
            );

            //渲染picking帧缓冲
            picking.render(scene.getMeshes(), uniforms);
            const { meshId, pickingId, point } = picking.pick(
                canvas.width / 2,
                canvas.height / 2,
                uniforms,
                {
                    viewMatrix : viewMatrix,
                    projMatrix : projMatrix,
                    returnPoint : true
                }
            );
            console.log(meshId, pickingId, point);
        }

        function getScene() {

            const aPickingId = [];
            for (let i = 0; i < cubeData.vertices.length / 3; i++) {
                aPickingId.push(10)
            }
            const cube = new reshader.Geometry(
                {
                    aPosition : cubeData.vertices,
                    aPickingId
                },
                cubeData.indices
            );
            cube.generateBuffers(regl);

            const cubeMesh = new reshader.Mesh(cube);

            const transformMat = mat4.identity([]);
            mat4.scale(transformMat, transformMat, [0.5, 0.5, 0.5]);
            cubeMesh.setLocalTransform(transformMat);

            const scene = new reshader.Scene([cubeMesh]);
            return scene;
        }

        function getViewProjection(cameraPos) {
            const aspect = canvas.width / canvas.height;
            const projMatrix = mat4.perspective([], 60 * Math.PI / 180, aspect, 1, 20);
            const viewMatrix = mat4.lookAt([], cameraPos, [0, 0, 0], [0, 1, 0]);
            const viewProjMatrix = mat4.multiply([], projMatrix, viewMatrix);
            return {
                viewProjMatrix,
                viewMatrix,
                projMatrix
            };
        }


    </script>
  </body>
</html>
