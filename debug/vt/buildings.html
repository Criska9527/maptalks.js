<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>pbr-buildings</title>

  <link rel="stylesheet" href="http://localhost/maptalks/dist/maptalks.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="screen.css" />
  <!-- 需要用 maptalks worker 分支下的版本 -->
  <script src="http://localhost/maptalks/dist/maptalks.js"></script>
  <script src="http://localhost/maptalksgl/dist/maptalksgl-dev.js"></script>
  <script src="buildings.js"></script>
  <script src="../../packages/vt/dist/maptalks.vt.js"></script>
  <script src="../../packages/vt.basic/dist/maptalks.vt.basic.js"></script>
  <script src="js/stats.min.js"></script>
</head>

<body>

  <div id="main">
    <div id="map2" style="width:100%;height:1000px;background-color:#ddd;"></div>
    <!-- <canvas id="shadow" width=512 height=512 style="float:left;border:1px red solid"></canvas>
    <canvas id="shadow2" width=512 height=512 style="float:left;border:1px red solid"></canvas> -->

  </div>

  <script>
    var stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild( stats.dom );
    window.MAPTALKS_VT_WORKER_COUNT = 1;


    var osm = new maptalks.TileLayer('osm', {
        crossOrigin : 'anonymous',
        // urlTemplate: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        urlTemplate: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        subdomains: ['a','b','c','d'],
        attribution : '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        // urlTemplate: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        //   subdomains: ['a','b','c','d'],
        //   attribution: '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>'
      });

    var map = new maptalks.Map('map2', {
      center: [13.416935229170008, 52.529564137540376],
      zoom: 15,
      pitch : 45,

      "center":[13.422091481252892,52.53081935839131],"zoom":17,"pitch":45,"bearing":0,

      "center":[13.420845330196812,52.53554217055179],"zoom":19,"pitch":33.00000000000021,"bearing":145.20000000000005,

      // bearing : -42,
      // baseLayer: osm
    });
    var id = 0;
    var data = buildings.reduce(function (v, b) {
      for (let i = 0, l = b.features.length; i < l; i++) {
        b.features[i].id = id++;
        v.features.push(b.features[i]);
      }
      return v;
    }, {
      "type" : "FeatureCollection",
      "features" : []
    })


    map.on('framestart', e => {
      stats.begin();
    });

    map.on('frameend', e => {
      stats.end();
    });

    console.log(data.features.length);

    const renderPlugin = {
        type : 'lit',
        dataConfig : {
          type : '3d-extrusion',
          altitudeProperty : 'levels',
          altitudeScale : 5,
          defaultAltitude : 1,
          normal : true,
          uv : true,
          uvSize : [128 / 50, 128 / 50],
          // shadowVolume : true,
          // shadowDir : [-1, -1, 0]
        },
        sceneConfig : {
          animation : 'easeOutBounce',
          material : {
            'baseColorFactor': [0.560, 0.570, 0.580, 1],
            'metallicFactor' : 0,
            'roughnessFactor' : 0.7,
            'reflectance': 0.5,
            'clearCoat': 3,
            // 'clearCoatNormalTexture': CLEAR_COAT_NORMAL_TEXTURE,
            'clearCoatRoughness': 0.5,
            // 'clearCoatIorChange': false,
            // 'normalTexture': NORMAL_TEXTURE,
            // 'metallicRoughnessTexture': ROUGHNESS_METALLIC_TEXTURE,
            // 'baseColorTexture': BASE_COLOR_TEXTURE,
            'anisotropy': 0
          },
          shadow : {
            type : 'vsm',
            // type : 'stencil',
            enable : true,
            quality : 'low',
            opacity : 0.5,
            color : [0, 0, 0],
            blurOffset : 1,
            // debug : ['shadow', 'shadow2']
          },
          lights : {
            ambient: {
              url: 'resources/windowStudio.hdr',
              luminance: 24000
            },
            directional: {
              color : [1, 1, 1],
              direction : [0, 1, 1],
              intensity: 30000
            }
          }
        }
      };

    const style =  [
      {
        filter : true,
        renderPlugin,
        symbol: {
          polygonOpacity: 1,
          polygonFill: {
            property : 'levels',
            stops : [
              [5, '#f00'],
              [3, '#fff700'],
              [1, '#fff']
            ]
          }
        }
      }
    ];

    // test tile clipping mask
    var layer1 = new maptalks.GeoJSONVectorTileLayer('polygon1', {
      debug : false,
      // canvas: debugCanvas,
      data: data,
      hitDetect : false,
    });
    layer1.setStyle(style);

    // map.on('click', function (e) {
    //   alert(JSON.stringify(layer1.identify(e.coordinate)));
    // });

    // map.addLayer(layer1);
    new maptalks.GroupGLLayer('group', [layer1]).addTo(map);

    map.on('click', e => {
      console.log(JSON.stringify(layer1.identify(e.coordinate)));
    });

    function updateStyle(imageMaps) {
      const sceneConfig = style[0].sceneConfig;
      const config = {
        material :  maptalks.Util.extend(sceneConfig.material, imageMaps)
      };
      if (imageMaps.hdr) {
        config.lights = sceneConfig.lights;
        delete config.lights.ambientCubeLight.url;
        config.lights.ambientCubeLight.data = imageMaps.hdr;
      }
      layer1.updateSceneConfig(0, config);
    }

    function updateMetallicRoughness() {
      const materialConfig = style[0].sceneConfig.material;
      maptalks.Util.extend(materialConfig, {
        metallic : +document.getElementById('metallic').value / 100,
        roughness : +document.getElementById('roughness').value / 100,
        ambientIntensity : +document.getElementById('ambientIntensity').value / 50 + 1.0,
      });
      layer1.updateSceneConfig(0, {
        material : materialConfig
      });
    }

  </script>
</body>

</html>
