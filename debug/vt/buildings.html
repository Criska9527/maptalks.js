<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>pbr-buildings</title>

  <link rel="stylesheet" href="/maptalks/dist/maptalks.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="screen.css" />
  <!-- 需要用 maptalks worker 分支下的版本 -->
  <script src="/maptalks/dist/maptalks.js"></script>
  <script src="/maptalksgl/dist/maptalksgl-dev.js"></script>
  <script src="buildings.js"></script>
  <script src="../../packages/vt/dist/maptalks.vt.js"></script>
  <script src="../../packages/vt.basic/dist/maptalks.vt.basic.js"></script>
  <script src="js/dat.gui.min.js"></script>
</head>

<body>

  <div id="main">
    <div id="map2" style="position:absolute;top:80px;width:100%;height:1000px;background-color:#fff;"></div>
    <!-- <canvas id="shadow" width=512 height=512 style="float:left;border:1px red solid"></canvas>
    <canvas id="shadow2" width=512 height=512 style="float:left;border:1px red solid"></canvas> -->

  </div>

  <script>
    var accessToken = 'pk.eyJ1IjoiemhlbmZ1IiwiYSI6ImNqamY2OXF0azA1M3kzdnF0enRoZm83aXQifQ.WpJebxPjCnmszaxHDRBrtw';
    var map = new maptalks.Map('map2', {
      center: [13.416935229170008, 52.529564137540376],
      zoom: 11,
      pitch : 45,
      // baseLayer: new maptalks.MapboxVectorTileLayer('vt', {
      //   urlTemplate: 'https://api.mapbox.com/v4/mapbox.mapbox-streets-v7/{z}/{x}/{y}.vector.pbf?access_token=' + accessToken,
      //   background: [0.925,0.878,0.792,1],
      //   style: 'mbtiles.json'
      // }),
      "center":[13.414627196474385,52.52909578112681],"zoom":16.309955844160633,"pitch":52.20000000000007,"bearing":0,
      "center":[13.418531244478004,52.533396361654326],"zoom":18.582413946875466,"pitch":52.20000000000007,"bearing":0,

      //纽约
      "center":[-74.00621804388925,40.70693481549321],"zoom":17.45624930433703,"pitch":52.80000000000042,"bearing":-15.59999999999991,

      // "center":[13.420845330196812,52.53554217055179],"zoom":19,"pitch":33.00000000000021,"bearing":145.20000000000005,

      // //阴影有裂缝
      // "center":[13.414905354183702,52.52913153292073],"zoom":20,"pitch":33.00000000000021,"bearing":145.20000000000005,

      // bearing : -42,
      // baseLayer: osm
    });

    const mapPostProcessConfig = {
      enable: false,
      filmicGrain: {
        enable: true,
        factor: 0.15
      },
      vignette: {
        enable: true
      },
      colorLUT: {
        enable: true,
        // lut: './lookup_miss_etikate.png'
        lut: './lookup.png'
      }
    };
    // map.setPostProcessConfig(mapPostProcessConfig);

    var id = 0;
    var data = buildings.reduce(function (v, b) {
      for (let i = 0, l = b.features.length; i < l; i++) {
        b.features[i].id = id++;
        v.features.push(b.features[i]);
      }
      return v;
    }, {
      "type" : "FeatureCollection",
      "features" : []
    })

    console.log(data.features.length);

    const renderPlugin = {
        type : 'lit',
        dataConfig : {
          type : '3d-extrusion',
          altitudeProperty : 'height',
          altitudeScale : 1,
          defaultAltitude : 1,
          normal : true,
          uv : true,
          uvScale : [1, 1],
          // tangent: true
          // shadowVolume : true,
          // shadowDir : [-1, -1, 0]
        },
        sceneConfig : {
          animation : 'easeOutBounce',
          shadow : {
            type : 'esm',
            // type : 'stencil',
            enable : true,
            quality : 'high',
            opacity : 0.7,
            color : [0, 0, 0],
            blurOffset : 1,
            // debug : ['shadow', 'shadow2']
          },
          lights : {
            ambient: {
              resource: 0,
              // color: [0.05, 0.05, 0.05],
              exposure: 2
            },
            directional: {
              color : [1, 1, 1],
              direction : [0, 1, 1],
              // intensity: 80000
            }
          }
        }
      };
      // #E9E7EC
    const litMaterial = {
      'baseColor': [233, 231, 236],
      'baseColorFactor': [233 / 255, 231 / 255, 236 / 255, 1],
      'metallicFactor' : 0,
      'roughnessFactor' : 0.598,
      'reflectance': 0.5,
      'clearCoat': 0,
      // 'clearCoatNormalTexture': CLEAR_COAT_NORMAL_TEXTURE,
      'clearCoatRoughness': 0.5,
      // 'clearCoatIorChange': false,
      // 'normalTexture': 'http://localhost/maptalksgl-dev/debug/reshader/ibl/resources/rusted_iron/609-normal.jpg',
      // 'metallicRoughnessTexture': ROUGHNESS_METALLIC_TEXTURE,
      // 'baseColorTexture': 'http://localhost/maptalksgl-dev/debug/reshader/ibl/resources/not-power-of-2.jpg',
      // 'anisotropy': 0,
      'uvScale': [1, 1],  //纹理坐标的缩放比例
      'uvScaleFactor': 1,
      'uvOffset': [0, 0]      //纹理坐标的偏移量
    };

    const style =  {
      $root: '.',
      resources: [
        {
          type: 'ambient',
          url: '{$root}/resources/autumn_ground.hdr',
          sh: [
            [0.08225932717323303, 0.1296476572751999, 0.18428272008895874],
            [-0.004491398110985756, -0.0062361168675124645, -0.005997033789753914],
            [0.02749081887304783, 0.057795193046331406, 0.1145947203040123],
            [0.03964025899767876, 0.03352731838822365, 0.020897403359413147],
            [-0.005459152162075043, -0.008918278850615025, -0.011838626116514206],
            [0.017447197809815407, 0.016732292249798775, 0.012003022246062756],
            [-0.003052285173907876, -0.00440911715850234, -0.004788860213011503],
            [0.01575229875743389, 0.017373336479067802, 0.015197779051959515],
            [0.018414868041872978, 0.027235284447669983, 0.030140453949570656]
          ]
        }
      ],
      style: [
        {
          filter : true,
          renderPlugin,
          symbol: {
            material: litMaterial,
            polygonOpacity: 1,
            polygonFill: {
              property : 'levels',
              stops : [
                [5, '#f00'],
                [3, '#fff700'],
                [1, '#fff']
              ]
            }
          }
        }
      ]
    };

    // test tile clipping mask
    // var layer = new maptalks.GeoJSONVectorTileLayer('polygon1', {
    //   debug : false,
    //   // canvas: debugCanvas,
    //   data: data,
    //   hitDetect : false,
    //   antialias: false,
    //   pickingPoint: true
    // });
    // layer.setStyle(style);

    style.style[0].filter = [
      "==",
      "$layer",
      "building"
    ];

    var layer = new maptalks.MapboxVectorTileLayer('buildings', {
      urlTemplate: 'https://api.mapbox.com/v4/mapbox.mapbox-streets-v7/{z}/{x}/{y}.vector.pbf?access_token=' + accessToken,
      style
    })

    // map.on('click', function (e) {
    //   alert(JSON.stringify(layer.identify(e.coordinate)));
    // });
    const sceneConfig = {
      shadow : {
        type : 'esm',
        // type : 'stencil',
        enable : true,
        quality : 'high',
        opacity : 0.7,
        color : [0, 0, 0],
        blurOffset : 1,
        lightDirection : [0, 1, 1]
        // debug : ['shadow', 'shadow2']
      },
      postProcess: {
        enable: true,
        antialias: {
          enable: true
        },
        ssao: {
          enable: false
        }
      }
    };
    // map.addLayer(layer);
    new maptalks.GroupGLLayer('group', [layer], { antialias: false, sceneConfig }).addTo(map);

    var bearing = 0;
    var paused = false;
    function changeView() {
      map.setBearing(bearing++);
      if (!paused) {
        requestAnimationFrame(changeView);
      }
    }

    // changeView();

    map.on('click', e => {
      console.log(JSON.stringify(map.getBaseLayer().identify(e.coordinate)));
    });

    initGUI();

    function initGUI() {
      const gui = new dat.GUI( { width: 250 } );
      const options = style.style[0].symbol.material;
      options.colorLUT = true;
      if (options['metallicFactor'] !== undefined) {
        gui.add(options, 'metallicFactor', 0, 1).onChange(function(value){
          updateMaterial('metallicFactor', value);
        });
        gui.add(options, 'clearCoat', 0, 5).onChange(function(value){
          updateMaterial('clearCoat', value);
        });

        gui.add(options, 'clearCoatRoughness', 0, 1).onChange(function(value){
          updateMaterial('clearCoatRoughness', value);
        });
      }
      gui.add(options, 'roughnessFactor', 0, 1).onChange(function(value){
        updateMaterial('roughnessFactor', value);
      });

      if (options['thickness']) {
        gui.add(options, 'thickness', 0, 1, 0.1).onChange(function(value){
          updateMaterial('thickness', value);
        });

        gui.add(options, 'subsurfacePower', 0, 30, 1).onChange(function(value){
          updateMaterial('subsurfacePower', value);
        });
      }

      gui.addColor(options, 'baseColor').onChange(function(value){
        updateMaterial('baseColor', value);
      });
      if (options['subsurface']) {
        gui.addColor(options, 'subsurface').onChange(function(value){
          updateMaterial('subsurface', value);
        });
      }
      gui.add(options, 'uvScaleFactor', 0.1, 5, 0.1).onChange(function(value){
        updateMaterial('uvScale', [1 / value, 1 / value]);
      });
      gui.add(options, 'colorLUT').onChange(function (value) {
        mapPostProcessConfig.colorLUT.enable = value;
        map.setPostProcessConfig(mapPostProcessConfig);
      });
    }

    function updateMaterial(key, value) {
      const material = {};
      material[key] = value;
      if (key === 'baseColor') {
        material['baseColorFactor'] = [material.baseColor[0] / 255, material.baseColor[1] / 255, material.baseColor[2] / 255, 1];
      } else if (key === 'subsurface') {
        material['subsurfaceColor'] = [material.subsurface[0] / 255, material.subsurface[1] / 255, material.subsurface[2] / 255];
      }
      layer.updateSymbol(0, {
        material
      });
    }

  </script>
</body>

</html>
